
/*
  Do not edit this file. It will be overwritten during updates.
  Use webpack.prod.js to customize the configuration.
*/

const path = require('path')
const webpack = require('webpack')
const ExtractTextPlugin = require('extract-text-webpack-plugin')
const configCommon = require('./webpack.config.common')
const fs = require('fs')

const entryJs = path.join(configCommon.absoluteSourcePath, configCommon.entryJs)
const nodeModules = 'node_modules'
const tmpDir = path.join(process.cwd(), 'devtools', 'tmp')
const rawModulelist = 'modulelist.txt'

const exportObject = {
  entry: entryJs,
  output: {
    path: tmpDir,
    filename: `${configCommon.bundleName}.js`
  },
  plugins: [
    new webpack.DefinePlugin({
      '__DEV__': false,
      'process.env': {
        'NODE_ENV': JSON.stringify('production')
      }
    }),
    new webpack.optimize.CommonsChunkPlugin({
      name: nodeModules,
      path: tmpDir,
      filename: `${nodeModules}.js`,
      minChunks (module, _count) {
        // ??? console.info(module.rawRequest)
        const resource = module.resource
        const fd = fs.openSync(path.join(tmpDir, rawModulelist), 'a')
        fs.writeSync(fd, `${resource}\r\n`)
        fs.close(fd)
        return false
      }
    })
  ],
  module: {
    rules: configCommon.allLoaders(ExtractTextPlugin)
  },
  resolve: configCommon.resolveEntry,
  resolveLoader: configCommon.resolveLoaderEntry
}

module.exports = exportObject
